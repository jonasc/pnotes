% This is based upon http://tex.stackexchange.com/questions/119191/extract-all-note-tags-from-beamer-as-a-simple-text-file

\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{pnotes}[2014/11/02 PDFPC Notes]


\RequirePackage{xstring}
\RequirePackage{ifthen}
\RequirePackage{kvoptions}

\DeclareStringOption[0]{duration}
\DeclareStringOption[0]{endslide}
\DeclareStringOption[.]{outputdir}
\ProcessKeyvalOptions*

\newwrite\pdfpcnotesfile
\newwrite\pdfpcendfile
\newread\pdfpcendfilein

\AtBeginDocument{%
    \immediate\openout\pdfpcnotesfile\jobname.pdfpc\relax
    \immediate\write\pdfpcnotesfile{[file]}
    \immediate\write\pdfpcnotesfile{\jobname.pdf}

    \ifcsname pnotes@duration\endcsname
        \ifnum\pnotes@duration>0
            \immediate\write\pdfpcnotesfile{[duration]}
            \immediate\write\pdfpcnotesfile{\pnotes@duration}
        \fi
        \ifnum\pnotes@endslide>0
            \immediate\write\pdfpcnotesfile{[end_user_slide]}
            \immediate\write\pdfpcnotesfile{\pnotes@endslide}
        \else
            \IfFileExists{\jobname.pce}{%
                \immediate\openin\pdfpcendfilein=\jobname.pce\relax
                \immediate\read\pdfpcendfilein to \pnotes@endslide
                \immediate\write\pdfpcnotesfile{[end_user_slide]}
                \immediate\write\pdfpcnotesfile{\pnotes@endslide}
            }{}
        \fi
    \fi

    \immediate\write\pdfpcnotesfile{[notes]}
}
\begingroup
    \catcode`\#=12
    \gdef\hashchar{#}%
\endgroup


\newcount\pnotelastframe
\pnotelastframe=0

\newcommand{\SetPnoteDuration}[1]{
    \newcommand{\pnoteduration}{#1}
}

\newcommand{\pnotewritenote}[1]{%
    \ifnum\value{framenumber}=\pnotelastframe\else
        \immediate\write\pdfpcnotesfile{\hashchar\hashchar\hashchar \theframenumber}%
    \fi
    %\immediate\write\pdfpcnotesfile{\unexpanded{#1}}%

    \expandarg%
    \StrSubstitute{\unexpanded{#1}}{\unexpanded{\par}}{\unexpanded{\\\\}}[\rRest]
    \StrCut{\rRest}{\unexpanded{\\}}\rFirst\rRest%
    \StrLen{\rFirst}[\lenFirst]
    \StrLen{\rRest}[\lenRest]
    \whiledo{\lenFirst > 0 \OR \lenRest > 0}{%
        \immediate\write\pdfpcnotesfile{- \rFirst}%
        \StrCut{\rRest}{\unexpanded{\\}}\rFirst\rRest%
        \StrLen{\rFirst}[\lenFirst]
        \StrLen{\rRest}[\lenRest]
    }

    \pnotelastframe=\value{framenumber}
}

\newcommand{\pnote}[1]{
    \only<1>{\pnotewritenote{#1}}
}

\newcommand{\plastslide}{%
    \immediate\openout\pdfpcendfile\jobname.pce\relax%
    \immediate\write\pdfpcendfile{\theframenumber}%
    \immediate\closeout\pdfpcendfile%
}

% close file on \begin{document}
\AtEndDocument{%
    \immediate\closeout\pdfpcnotesfile
    \immediate\write18{iconv --output="\pnotes@outputdir/\jobname.pdfpc" --from-code=ISO_8859-15 --to-code=UTF-8 "\pnotes@outputdir/\jobname.pdfpc"}
}

